# Pipeline principal - Orchestrateur des pipelines enfants (propres à chaque image)


include:
  - local: '.gitlab/ci/templates/promote-deploy-template.yml'

variables:
  TAG: $CI_COMMIT_SHORT_SHA
  
  # Chemin vers le repertoire qui contient les Charts Helm
  CHARTS_DIR: Helm
  
  # Nom du projet de Déploiement, situé dans le même groupe GitLab
  DEPLOY_PROJECT: projet_fastapi_deploy
  
  # Access Token pour push sur le repo du projet Deploy
  DEPLOY_PROJECT_TOKEN: "" # GROUP_REPO_TOKEN
  
  # Trigger Token du projet Deploy, employé en fallback
  TRIGGER_TOKEN: $TRIGGER_TOKEN_DEPLOY
  
  # Permettre le déclenchement manuel des jobs (utile en test)
  MANUAL_MODE: true


stages:
  - build_push
  - aggregation
  - update_deploy


# ----------------------------------------------
# Frontend job - Trigger Build, Run, Push child
# ----------------------------------------------
frontend:
  stage: build_push
  trigger:
    include: ".gitlab/ci/templates/build-template.yml"
    strategy: depend
  variables:
    # vérifie la valeur des variables et échoue si absente. Laisser vide ou bien "disabled" pour annuler le check.
    REQUIRED_VARS: "IMAGENAME TAG HOSTPORT CONTAINERPORT URL_PATH"
    
    IMAGENAME: frontend
    HOSTPORT: 6080
    CONTAINERPORT: 80
    URL_PATH: "/"

  rules:
    - changes:
        - $IMAGENAME/**   # ne se déclenche que si les fichiers du dossiers changent
    
    # fallback de déclenchement manuel en mode Dev
    - if: '$MANUAL_MODE =~ /^(1|true|yes)$/'
      when: manual
    
    # sinon, ne jamais déclencher
    - when: never


# # Promouvoir l'image en déploiement Dev
# update_chart_frontend:
#   stage: promote_frontend
#   extends:
#     - .install_yq_v4
#     - .push_tag_deploy_dev
#   variables:
#     IMAGENAME: frontend
#     CHART_PATH: $CHARTS_DIR/frontend
#     VALUES_FILE: values-dev.yaml
#   needs:
#     - job: frontend
#       optional: true


# fallback_trigger_frontend:
#   stage: promote_frontend
#   extends: .api_trigger_pipeline
#   needs:
#     - job: update_chart_frontend
#       artifacts: true
#   rules:
#     - if: '$TAG_PUSHED != "success"'
#   variables:
#     IMAGENAME: frontend
#     REF: dev


# ----------------------------------------------
# Backend job - Trigger Build, Run, Push child
# ----------------------------------------------
backend:
  stage: build_push
  trigger:
    include: ".gitlab/ci/templates/build-template.yml"    # .gitlab/ci/templates/build-template.yml
    strategy: depend
  variables:
    # vérifie la valeur des variables et échoue si absente. Laisser vide ou bien "disabled" pour annuler le check.
    REQUIRED_VARS: "IMAGENAME TAG HOSTPORT CONTAINERPORT URL_PATH"
    
    IMAGENAME: backend
    HOSTPORT: 7800
    CONTAINERPORT: 8000
    URL_PATH: "/api/v1/utils/health-check/"

  rules:
    - changes:
        - $IMAGENAME/**   # ne se déclenche que si les fichiers du dossiers changent
    
    # fallback de déclenchement manuel en mode Dev
    - if: '$MANUAL_MODE =~ /^(1|true|yes)$/'
      when: manual
    
    # sinon, ne jamais déclencher
    - when: never


# # Promouvoir l'image en déploiement Dev
# update_chart_backend:
#   stage: promote_backend
#   extends:
#     - .install_yq_v4
#     - .push_tag_deploy_dev
#   variables:
#     IMAGENAME: backend
#     CHART_PATH: $CHARTS_DIR/backend
#     VALUES_FILE: values-dev.yaml
#   needs:
#     - job: backend
#       optional: true


# fallback_trigger_backend:
#   stage: promote_backend
#   extends: .api_trigger_pipeline
#   needs:
#     - job: update_chart_backend
#       artifacts: true
#   variables:
#     IMAGENAME: backend
#     REF: dev


# ----------------------------------------------
# Build & Push Jobs results aggregation
# - Détecter les jobs build_push qui ont réussi
# - Aggréger les résultats au format image:tag
# ----------------------------------------------
frontend_detected:
  stage: aggregation
  needs:
    - job: frontend
  script:
    - echo "frontend" > frontend.image
  artifacts:
    when: on_success
    paths:
      - frontend.image

backend_detected:
  stage: aggregation
  needs:
    - job: backend
  script:
    - echo "backend" > backend.image
  artifacts:
    when: on_success
    paths:
      - backend.image

aggregate_images:
  stage: aggregation
  needs:
    - frontend_detected
    - backend_detected
  script:
    - |
      UPDATED_IMAGES=$(cat *.image | paste -sd "," -)
      echo "UPDATED_IMAGES=$UPDATED_IMAGES" >> deploy.env
    
    - echo "$UPDATED_IMAGES"
    - cat deploy.env

  artifacts:
    reports:
      dotenv: deploy.env


# ----------------------------------------------
# Trigger Deploy Project
# - Transmettre le résultat aggrégé au pipeline Deploy
# ----------------------------------------------
trigger_deploy:
  stage: update_deploy
  needs:
    - aggregate_images
  trigger:
    # déclencher le pipeline deploy sur le même nom de branche que App
    project: group/projet_fastapi_deploy
    ref: $CI_COMMIT_REF_NAME
    strategy: depend
  variables:
    UPDATED_IMAGES: $UPDATED_IMAGES
    UPDATED_TAG: $TAG
