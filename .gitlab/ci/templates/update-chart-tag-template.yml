# Modèle de pipeline permettant d'envoyer le TAG de l'image construite vers le dépôt de Déploiement dans le même projet
# Clone le dépot de déploiement, écrit le Tag de le fichiers values-dev.yaml, commit et push pour publier le tag et déclehn cer le pipeline Deploy 

##### Upstream variables ##### 
# Les variables suivantes doivent être définies dans l'appelant
#
#   IMAGENAME:      nom de l'image Docker
#   TAG:            tag de l'image Docker
#   DEPLOY_REPO:    nom du dépôt de déploiement, dans le même projet GitLab. Le chemin sera dynamiquement évalué.
#   CHART:          chemin du repertoire qui contient le Chart du micro-service
#


# ----------------------------------------------
# Publier le tag dans values.yaml du repo Deploy
# Choix du Token
# ├─ Project Access Token : non disponible sur GitLab Free plan
# ├─ Personal Token : 
# └─ CI_JOB_TOKEN : ne permet pas de faire un push sur le repo d'un autre projet
# ----------------------------------------------
.update_helm_values:
  script:
    - WORKING_BRANCH="$CI_COMMIT_REF_NAME"
    - HELM_REPO_URL="https://oauth2:${REPO_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_NAMESPACE}/${DEPLOY_REPO}"
    
    - git clone "$HELM_REPO_URL"
    - cd "$DEPLOY_REPO"
    
    - |
      # Vérifie si la branche existe côté remote
      if git ls-remote --exit-code --heads origin "$WORKING_BRANCH" > /dev/null; then
        git checkout "$WORKING_BRANCH"
      else
        echo "Branch $WORKING_BRANCH does not exist in deploy repo, creating it"
        git checkout -b "$WORKING_BRANCH" origin/main
      fi

    - |
      cd "$CHART"
    - pwd
    - ls -l values-dev.yaml
    - yq e -i '.image.tag = env(TAG)' values-dev.yaml
    - git commit -am "Deploy ${IMAGENAME} ${TAG} [skip ci]"
    - git push origin "$WORKING_BRANCH"


# ----------------------------------------------
# Installer YQ latest si besoin
# ----------------------------------------------
.install_yq_v4:
  before_script:
    - |
      set -e

      REQUIRED_MAJOR=4
      INSTALL_DIR="$HOME/bin"
      YQ_BIN="$INSTALL_DIR/yq"

      mkdir -p "$INSTALL_DIR"
      export PATH="$INSTALL_DIR:$PATH"

      INSTALL_YQ=false

      if command -v yq >/dev/null 2>&1; then
        CURRENT_VERSION="$(yq --version | sed -E 's/[^0-9]*([0-9]+).*/\1/')"
        echo "Found yq version $CURRENT_VERSION"

        if [ "$CURRENT_VERSION" -ge "$REQUIRED_MAJOR" ]; then
          echo "yq version is sufficient, skipping installation"
        else
          echo "yq version is too old, installing latest v4+"
          INSTALL_YQ=true
        fi
        
      else
        echo "yq not found, installing latest v4+"
        INSTALL_YQ=true
      fi

      if [ "$INSTALL_YQ" = true ]; then
        curl -sSL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 \
          -o "$YQ_BIN"
        chmod +x "$YQ_BIN"
      fi

      yq --version