# ----------------------------------------------
# PRECHECKS des Varialbles
# Les passages de variables sont parfois complexes entre les différents niveaux de pipeline
# Il est donc opportun de vérifier que les variables nécessaires sont correctement définies
# sinon, on arrête le pipeline immédiatement
# ----------------------------------------------

.var_checks_template:
  stage: pre_checks
  script:
    - |
      # Guard: skip debug if DEBUG_VARS is empty or disabled
      if [ -z "$DEBUG_VARS" ] || [ "$DEBUG_VARS" = "disabled" ]; then
        echo "DEBUG_VARS is empty or disabled, skipping variable checks."
        exit 0
      fi
      
      echo "Checking value of required variables..."
      
      # Convert string to array
      IFS=' ' read -r -a VARS_ARRAY <<< "$DEBUG_VARS"

      for VAR in "${VARS_ARRAY[@]}"; do
        if [ -z "${!VAR}" ]; then
          echo "Error: Environment variable '$VAR' is NOT set."
          MISSING=1
        else
          echo "$VAR = '${!VAR}'"
        fi
      done

      # Fail job if at least one variable is missing
      if [ "$MISSING" = 1 ]; then
        echo "Aborting: Missing environment variables."
        exit 1
      fi
